module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseDatabase=void 0;const s=o(n(16));class i{getConnection(){return i.connection||(i.connection=s.default({client:"mysql",connection:{host:process.env.DB_HOST,port:3306,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME}})),i.connection}static destroyConnection(){return r(this,void 0,void 0,(function*(){i.connection&&(yield i.connection.destroy(),i.connection=null)}))}}t.BaseDatabase=i,i.connection=null},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidInputError=void 0;const r=n(3);class o extends r.BaseError{constructor(e){super(e,422)}}t.InvalidInputError=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseError=void 0;class r extends Error{constructor(e,t){super(e),this.errorCode=t}}t.BaseError=r},function(e,t){e.exports=require("dotenv")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SYSTEM_ROLE=t.stringToUserRole=t.User=void 0;const r=n(2);var o;t.User=class{constructor(e,t,n,r,o,s){this.id=e,this.name=t,this.email=n,this.password=r,this.role=o,this.nickname=s}getId(){return this.id}getName(){return this.name}getEmail(){return this.email}getPassword(){return this.password}getRole(){return this.role}getNickname(){return this.nickname}},t.stringToUserRole=e=>{switch(e){case"NORMAL":return o.NORMAL;case"ADMIN":return o.ADMIN;default:throw new r.InvalidInputError("Please insert a valid role")}},function(e){e.ADMIN="ADMIN",e.NORMAL="NORMAL"}(o=t.SYSTEM_ROLE||(t.SYSTEM_ROLE={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotFound=void 0;const r=n(3);class o extends r.BaseError{constructor(e){super(e,404)}}t.NotFound=o},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HashGenerator=void 0;const s=o(n(19));t.HashGenerator=class{constructor(){this.hash=e=>r(this,void 0,void 0,(function*(){const t=Number(process.env.HASH_ROUNDS),n=yield s.default.genSalt(t);return yield s.default.hash(e,n)})),this.compareHash=(e,t)=>r(this,void 0,void 0,(function*(){return s.default.compare(e,t)}))}}},function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TokenGenerator=void 0;const a=s(n(20));i(n(4)).default.config();class u{constructor(){this.generate=e=>a.sign({id:e.id,role:e.role},process.env.JWT_KEY,{expiresIn:u.expiresIn})}verify(e){const t=a.verify(e,process.env.JWT_KEY);return{id:t.id,role:t.role}}}t.TokenGenerator=u,u.expiresIn=1200},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdGenerator=void 0;const r=n(21);t.IdGenerator=class{generate(){return r.v4()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Band=void 0;t.Band=class{constructor(e,t,n,r,o,s,i){this.id=e,this.name=t,this.email=n,this.password=r,this.description=o,this.is_approved=s,this.nickname=i}getId(){return this.id}getName(){return this.name}getEmail(){return this.email}getPassword(){return this.password}getIsApproved(){return this.is_approved}getDescription(){return this.description}getNickname(){return this.nickname}}},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.handler=void 0;const o=r(n(12)),s=n(13);t.handler=o.default(s.app)},function(e,t){e.exports=require("serverless-http")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0;const o=r(n(1)),s=r(n(4)),i=n(14),a=n(22),u=r(n(27));s.default.config(),t.app=o.default(),t.app.use(u.default({origin:!0})),t.app.use(o.default.json()),t.app.use("/users",i.userRouter),t.app.use("/bands",a.bandRouter);const c=t.app.listen(process.env.PORT||3333,()=>{if(c){const e=c.address();console.log("Server is running in http://localhost:"+e.port)}else console.error("Failure upon starting server.")})},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.userRouter=void 0;const o=r(n(1)),s=n(15);t.userRouter=o.default.Router();const i=new s.UserController;t.userRouter.post("/signup",i.signUp),t.userRouter.post("/login",i.login)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0;const o=n(0),s=n(17),i=n(18),a=n(7),u=n(8),c=n(9);class d{signUp(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield d.UserBusiness.signup(e.body.name,e.body.email,e.body.password,e.body.role,e.body.nickname);t.status(200).send(n)}catch(e){t.status(e.errorCode||400).send({message:e.message})}o.BaseDatabase.destroyConnection()}))}login(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield d.UserBusiness.login(e.body.nickname,e.body.password);t.status(200).send({token:n})}catch(e){t.status(e.errorCode||400).send({message:e.message})}o.BaseDatabase.destroyConnection()}))}}t.UserController=d,d.UserBusiness=new i.UserBusiness(new s.UserDatabase,new a.HashGenerator,new u.TokenGenerator,new c.IdGenerator)},function(e,t){e.exports=require("knex")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserDatabase=void 0;const o=n(0),s=n(5);class i extends o.BaseDatabase{toModel(e){return e&&new s.User(e.id,e.name,e.email,e.password,e.role,e.nickname)}signUp(e){return r(this,void 0,void 0,(function*(){yield this.getConnection().raw(`\n          INSERT INTO ${i.TABLE_NAME}\n          VALUES (\n              "${e.getId()}",\n              "${e.getName()}",\n              "${e.getEmail()}",\n              "${e.getPassword()}",\n              "${e.getRole()}",\n              "${e.getNickname()}"\n          )`)}))}fetchEmail(e){return r(this,void 0,void 0,(function*(){const t=yield this.getConnection().raw(`\n    SELECT * FROM ${i.TABLE_NAME} WHERE nickname = "${e}"`);return this.toModel(t[0][0])}))}}t.UserDatabase=i,i.TABLE_NAME="Spotenu_Users"},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserBusiness=void 0;const o=n(2),s=n(5),i=n(6);t.UserBusiness=class{constructor(e,t,n,r){this.userDatabase=e,this.hashGenerator=t,this.tokenGenerator=n,this.idGenerator=r}signup(e,t,n,i,a){return r(this,void 0,void 0,(function*(){if(!(e&&t&&n&&i&&a))throw new o.InvalidInputError("There is an input missing");if(-1===t.indexOf("@")||t.indexOf(".")<t.indexOf("@"))throw new o.InvalidInputError("Invalid email format");if(n.length<6)throw new o.InvalidInputError("Invalid password");const r=this.idGenerator.generate(),u=yield this.hashGenerator.hash(n);yield this.userDatabase.signUp(new s.User(r,e,t,u,s.stringToUserRole(i),a));return{accessToken:this.tokenGenerator.generate({id:r,role:i})}}))}login(e,t){return r(this,void 0,void 0,(function*(){if(!e||!t)throw new o.InvalidInputError("You need both parameters to log in!");const n=yield this.userDatabase.fetchEmail(e);if(!n)throw new i.NotFound("User not found");if(!(yield this.hashGenerator.compareHash(t,n.getPassword())))throw new o.InvalidInputError("Invalid password");return this.tokenGenerator.generate({id:n.getId(),role:n.getRole()})}))}}},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("uuid")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.bandRouter=void 0;const o=r(n(1)),s=n(23);t.bandRouter=o.default.Router();const i=new s.BandController;t.bandRouter.post("/signup",i.signUp),t.bandRouter.get("/all",i.fetchBands)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BandController=void 0;const o=n(0),s=n(7),i=n(8),a=n(9),u=n(24),c=n(26);class d{signUp(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield d.BandBusiness.signup(e.body.name,e.body.email,e.body.password,e.body.description,e.body.nickname);t.status(200).send({message:""+n.accessToken})}catch(e){t.status(e.errorCode||400).send({message:e.message})}o.BaseDatabase.destroyConnection()}))}fetchBands(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield e.headers.token,r=yield d.BandBusiness.fetchBands(n);t.status(200).send({result:r})}catch(e){t.status(400|e.statusCode).send({message:e.message})}}))}}t.BandController=d,d.BandBusiness=new u.BandBusiness(new c.BandDatabase,new s.HashGenerator,new i.TokenGenerator,new a.IdGenerator)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BandBusiness=void 0;const o=n(2),s=n(10),i=n(25),a=n(6);t.BandBusiness=class{constructor(e,t,n,r){this.bandDatabase=e,this.hashGenerator=t,this.tokenGenerator=n,this.idGenerator=r}signup(e,t,n,i,a){return r(this,void 0,void 0,(function*(){if(!(e&&t&&n&&i&&a))throw new o.InvalidInputError("There is an input missing");if(-1===t.indexOf("@")||t.indexOf(".")<t.indexOf("@"))throw new o.InvalidInputError("Invalid email format");if(n.length<6)throw new o.InvalidInputError("Invalid password");const r=this.idGenerator.generate(),u=yield this.hashGenerator.hash(n);yield this.bandDatabase.signUp(new s.Band(r,e,t,u,i,0,a));return{accessToken:this.tokenGenerator.generate({id:r,role:"NORMAL"})}}))}fetchBands(e){return r(this,void 0,void 0,(function*(){if("ADMIN"!==(yield this.tokenGenerator.verify(e)).role)throw new i.Unauthorized("You do not have access to this function.");return yield this.bandDatabase.fetchBands()}))}login(e,t){return r(this,void 0,void 0,(function*(){if(!e||!t)throw new o.InvalidInputError("You need both parameters to log in!");const n=yield this.bandDatabase.login(e);if(!n)throw new a.NotFound("User not found");if(!(yield this.hashGenerator.compareHash(t,n.getPassword())))throw new o.InvalidInputError("Invalid password");if(0===n.getIsApproved)throw new i.Unauthorized("Your band still needs to be approved by an admin before you can log in");return this.tokenGenerator.generate({id:n.getId(),role:n.getRole()})}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Unauthorized=void 0;const r=n(3);class o extends r.BaseError{constructor(e){super(e,401)}}t.Unauthorized=o},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BandDatabase=void 0;const o=n(0),s=n(10);class i extends o.BaseDatabase{toModel(e){return e&&new s.Band(e.id,e.name,e.email,e.password,e.description,e.is_approved,e.nickname)}signUp(e){return r(this,void 0,void 0,(function*(){yield this.getConnection().raw(`\n          INSERT INTO ${i.TABLE_NAME}\n          VALUES (\n              "${e.getId()}",\n              "${e.getName()}",\n              "${e.getEmail()}",\n              "${e.getDescription()}",\n              "${e.getIsApproved()}",\n              "${e.getPassword()}",\n              "${e.getNickname()}"\n          )`)}))}fetchBands(){return r(this,void 0,void 0,(function*(){return(yield this.getConnection().raw("\n    SELECT name, nickname, email, is_approved FROM Spotenu_Bands;"))[0]}))}login(e){return r(this,void 0,void 0,(function*(){return(yield this.getConnection().raw(`\n    SELECT * FROM Spotenu_Bands WHERE nickname = "${e}";`))[0]}))}}t.BandDatabase=i,i.TABLE_NAME="Spotenu_Bands"},function(e,t){e.exports=require("cors")}]);